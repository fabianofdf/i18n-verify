<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Labels Verify</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <style media="screen">
      td{word-break: break-all;}
    </style>
  </head>

  <body>
    <header class="jumbotron jumbotron-fluid p-4">
      <div class="container">
        <h1 class="display-4">Labels Verify</h1>
        <p class="lead">It is a library that allows you to check labels that aren't used anymore</p>
      </div>
    </header>

    <div class="container">
      <form id="form" class="pb-4">
          <div class="form-group">
            <label for="labelsPath">Labels File Path</label>
            <input type="text" class="form-control" id="labelsPath" name="labelsPath" placeholder="e.g. /home/projects/my-project/languages/pt-br.json">
          </div>

          <div class="form-group">
            <label for="baseDirPath">Root Directory Path</label>
            <input type="text" class="form-control" id="baseDirPath" name="baseDirPath" placeholder="e.g. /home/projects/my-project/src">
          </div>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>

      <div class="d-none" id="loading"></div>

      <div id="result" class="d-none">
        <div class="row">
          <div class="col">
            <span>Total labels: <label id="total_labels"></label></span> -
            <span>Total words: <label id="total_words"></label></span>
          </div>

          <div class="col text-right">
            <button id="filter-not-useds" class="btn btn-link">Unused labels</button> -
            <button id="filter-all" class="btn btn-link">All</button>
          </div>
        </div>

        <div class="row">


        <table class="table table-striped table-sm table-hover">
          <thead>
            <tr>
              <th scope="col">Label text</th>
              <th scope="col">Total used</th>
            </tr>
          </thead>
          <tbody id="list">
          </tbody>
        </table>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      const ge = id => document.getElementById(id)
      let foundLabels
      let currentLabels

      const setLoading = opt => {
        const containerResult = ge('result')
        const containerLoading = ge('loading')

        if (opt) {
          containerLoading.className = 'd-block'
          containerLoading.innerHTML = '<p class="display-5">Verifying...</p>'
          containerResult.className = 'd-none'
        } else {
          containerLoading.className = 'd-none'
          containerResult.className = 'd-block'
        }
      }

      const printCurrentLabelsList = () => {
        const totalLabels = ge('total_labels')
        const totalWords = ge('total_words')
        const list = ge('list')

        totalLabels.innerHTML = currentLabels.length
        totalWords.innerHTML = currentLabels.reduce((total, item) => {
          total += item.text.split(" ").length
          return total
        }, 0)
        list.innerHTML = currentLabels.reduce((html, item) => (
          html+=`
            <tr>
              <td><strong>${item.label}</strong> - ${item.text}</td>
              <td class="text-right"><span class="badge badge-${item.uses ? 'success' : 'warning'}">${item.uses}</span></td>
            </tr>`
        ), '')
        setLoading(false)
      }

      const printAllLabels = () => {
        currentLabels = foundLabels
        printCurrentLabelsList()
      }

      const printUnusedLabels = () => {
        currentLabels = foundLabels.filter(({ uses }) => uses === 0)
        printCurrentLabelsList()
      }

      const setLocalStorage = () => {
        localStorage.setItem('labelsPath', form.labelsPath.value)
        localStorage.setItem('baseDirPath', form.baseDirPath.value)
      }

      const setFormByLocalStorage = () => {
        form.labelsPath.value = localStorage.getItem('labelsPath') || ''
        form.baseDirPath.value = localStorage.getItem('baseDirPath') || ''
      }

      const verify = (event) => {
        event.preventDefault()
        const fetchParams = {
          method: "post",
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            labelsPath: form.labelsPath.value,
            baseDirPath: form.baseDirPath.value
          })
        }

        const processSuccess = resp => {
          if(resp.ok){
            resp.json().then(function(resp) {
              foundLabels = resp
              printUnusedLabels()
            })
          } else {
            resp.text().then(function(text) {
              processErro(text)
            })
          }
        }

        const processErro = errorText => {
          ge('loading').innerHTML = '<h4>'+errorText+'</h4>'
        }

        setLocalStorage()
        setLoading(true)
        fetch('/analyse', fetchParams)
          .then(processSuccess)
          .catch(processErro)
      }

      const init = () => {
        ge('filter-all').addEventListener("click", printAllLabels)
        ge('filter-not-useds').addEventListener('click', printUnusedLabels)
        ge('form').addEventListener('submit', verify)
        setFormByLocalStorage()
      }

      window.addEventListener('load', init)
    </script>
  </body>
</html>
