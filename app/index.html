<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>i18n Labels Verify</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <style media="screen">
      .header{background-color: #eee;margin-bottom: 10px;}
      .list-group-item{display: flex; align-items: center;}
      .list-group-item span:first-child{flex: 1;}
      .badge-success{color: #fff; background-color: #28a745;}
      .badge-warning{color: #111; background-color: #ffc107;}
      .d-block{display: block;}
      .d-none{display: none;}
      .form{margin:15px auto;}
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1 class="display-5">i18n Labels Verify</h1>
        <p>Verify i18n labels that aren't used any more</p>
      </div>
    </div>
    <div class="container form">
      <form id="form">
        <div class="form-group">
          <label for="langPath">Lang File Path</label>
          <input type="text" class="form-control" id="langPath" name="langPath" placeholder="e.g. /home/projects/hotmart/hot-vulcano/languages/pt-BR.i18n.json">
        </div>
        <div class="form-group">
          <label for="baseDirPath">Root Directory Path</label>
          <input type="text" class="form-control" id="baseDirPath" name="baseDirPath" placeholder="e.g. /home/projects/hotmart/hot-vulcano/imports/client">
        </div>
        <button type="button" id="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <div class="container d-none" id="loading"></div>
    <div class="container d-none" id="result">
      <div class="row">
        <div class="col-xs-6">
          <span>Total labels: <label id="total_labels"></label></span> -
          <span>Total words: <label id="total_words"></label></span>
        </div>
        <div class="col-xs-6 text-right">
          <a href="#" id="filter-not-useds">Unused labels</a> -
          <a href="#" id="filter-all">All</a>
        </div>
      </div>
      <ul class="list-group" id="list"></ul>
    </div>
    <script type="text/javascript">
      const ge = id => document.getElementById(id);
      let totalLabels = ge('total_labels');
      let totalWords = ge('total_words');
      let list = ge('list');
      let linkAll = ge('filter-all');
      let linkNotUseds = ge('filter-not-useds');
      let containerLoading = ge('loading');
      let containerResult = ge('result');
      let submitButton = ge('submit');

      ge('langPath').value = localStorage.getItem('langPath') || '';
      ge('baseDirPath').value = localStorage.getItem('baseDirPath') || "";

      let labels;
      let currentLabels;

      let setLoading = (opt) => {
        if (opt) {
          containerLoading.className = 'container d-block';
          containerLoading.innerHTML = '<h4>Verifying...</h4>';
          containerResult.className = 'container d-none';
        } else {
          containerLoading.className = 'container d-none';
          containerResult.className = 'container d-block';
        }
      };

      let loadList = () => {
        totalLabels.innerHTML = currentLabels.length;
        totalWords.innerHTML = currentLabels.reduce((total, item) => {
          total += item.text.split(" ").length;
          return total;
        }, 0);
        list.innerHTML = currentLabels.reduce((html, item) => (
          html+=`
            <li class="list-group-item">
              <span><strong>${item.label}</strong> - ${item.text}</span>
              <span class="badge badge-${item.uses ? 'success' : 'warning'}">${item.uses}</span>
            </li>`
        ), '');
        setLoading(false);
      };

      let loadAll = () => {
        currentLabels = labels;
        loadList();
      };

      let loadUnused = () => {
        currentLabels = labels.filter(item => item.uses === 0);
        loadList();
      };

      let verify = () => {
        localStorage.setItem('langPath', form.langPath.value);
        localStorage.setItem('baseDirPath', form.baseDirPath.value);

        setLoading(true);
        fetch('/analyse',{
          method: "post",
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            langPath: form.langPath.value,
            baseDirPath: form.baseDirPath.value
          })
        }).then(resp => {
          if(resp.ok){
            resp.json().then(function(resp) {
              labels = resp
              loadUnused();
            })
          } else {
            resp.text().then(function(text) {
              containerLoading.innerHTML = '<h4>'+text+'</h4>';
            })
          }
        }).catch(err => {
          containerLoading.innerHTML = '<h4>'+err+'</h4>';
        });
      };

      linkAll.addEventListener("click", loadAll);
      linkNotUseds.addEventListener('click', loadUnused);
      submitButton.addEventListener('click', verify);

    </script>
  </body>
</html>
